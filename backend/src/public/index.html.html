<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4AM Company Management System - Complete</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a1a 50%, #000000 100%);
            color: #ffffff;
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header Styles */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 2px solid #333;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
        }

        .logo h1 {
            color: #00d4ff;
            font-size: 2rem;
            font-weight: 700;
            text-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
        }

        .logo i {
            margin-left: 10px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        .nav {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        /* Button Styles */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(45deg, #00d4ff, #0099cc);
            color: #000;
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 212, 255, 0.5);
        }

        .btn-secondary {
            background: transparent;
            color: #00d4ff;
            border: 2px solid #00d4ff;
        }

        .btn-secondary:hover {
            background: #00d4ff;
            color: #000;
        }

        .btn-danger {
            background: linear-gradient(45deg, #ff4757, #ff3742);
            color: #fff;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 71, 87, 0.4);
        }

        /* Main Content */
        .main-content {
            padding: 40px 0;
        }

        /* Welcome Section */
        .welcome-section {
            text-align: center;
            padding: 60px 0;
        }

        .welcome-content h2 {
            font-size: 3rem;
            margin-bottom: 20px;
            background: linear-gradient(45deg, #00d4ff, #ffffff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .welcome-content p {
            font-size: 1.2rem;
            color: #cccccc;
            margin-bottom: 50px;
        }

        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-top: 50px;
        }

        .feature {
            background: rgba(255, 255, 255, 0.05);
            padding: 40px 30px;
            border-radius: 15px;
            border: 1px solid rgba(0, 212, 255, 0.2);
            transition: all 0.3s ease;
        }

        .feature:hover {
            transform: translateY(-10px);
            border-color: #00d4ff;
            box-shadow: 0 10px 30px rgba(0, 212, 255, 0.2);
        }

        .feature i {
            font-size: 3rem;
            color: #00d4ff;
            margin-bottom: 20px;
        }

        .feature h3 {
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: #ffffff;
        }

        .feature p {
            color: #cccccc;
            font-size: 1rem;
        }

        /* Form Styles */
        .form-section {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 70vh;
        }

        .form-container {
            background: rgba(255, 255, 255, 0.05);
            padding: 40px;
            border-radius: 20px;
            border: 1px solid rgba(0, 212, 255, 0.3);
            backdrop-filter: blur(10px);
            width: 100%;
            max-width: 500px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .form-container h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #00d4ff;
            font-size: 2rem;
        }

        .input-group {
            margin-bottom: 25px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #ffffff;
            font-weight: 600;
        }

        .input-group input,
        .input-group select,
        .input-group textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid rgba(0, 212, 255, 0.3);
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.3);
            color: #ffffff;
            font-size: 1rem;
            transition: all 0.3s ease;
            font-family: 'Cairo', sans-serif;
        }

        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: #00d4ff;
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.3);
        }

        .input-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-link {
            text-align: center;
            margin-top: 20px;
            color: #cccccc;
        }

        .form-link a {
            color: #00d4ff;
            text-decoration: none;
            font-weight: 600;
        }

        .form-link a:hover {
            text-decoration: underline;
        }

        /* Dashboard Styles */
        .dashboard {
            padding: 20px 0;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            border: 1px solid rgba(0, 212, 255, 0.2);
        }

        .dashboard-header h2 {
            color: #00d4ff;
            font-size: 2rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 30px;
            border-radius: 15px;
            border: 1px solid rgba(0, 212, 255, 0.2);
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: #00d4ff;
            box-shadow: 0 10px 25px rgba(0, 212, 255, 0.2);
        }

        .stat-card i {
            font-size: 2.5rem;
            color: #00d4ff;
            margin-bottom: 15px;
        }

        .stat-card h3 {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: #ffffff;
        }

        .stat-card span {
            font-size: 2rem;
            font-weight: 700;
            color: #00d4ff;
        }

        .admin-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .action-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(0, 212, 255, 0.3);
            color: #ffffff;
            padding: 25px;
            border-radius: 15px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .action-btn:hover {
            background: rgba(0, 212, 255, 0.1);
            border-color: #00d4ff;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 212, 255, 0.2);
        }

        .action-btn i {
            font-size: 1.3rem;
        }

        /* Admin Tasks Section */
        .admin-tasks-section {
            margin-top: 40px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 30px;
            border: 1px solid rgba(0, 212, 255, 0.2);
        }

        .admin-tasks-section h3 {
            color: #00d4ff;
            font-size: 1.5rem;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .admin-tasks-section h3 i {
            font-size: 1.3rem;
        }

        /* Task Details */
        .task-details {
            line-height: 1.8;
        }

        .task-details h4 {
            color: #00d4ff;
            margin-bottom: 20px;
            font-size: 1.3rem;
        }

        .task-details p {
            margin-bottom: 10px;
            color: #cccccc;
        }

        .task-details strong {
            color: #ffffff;
        }

        /* Admin Tasks Stats */
        .admin-tasks-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .admin-task-stat {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(0, 212, 255, 0.2);
            text-align: center;
        }

        .admin-task-stat h4 {
            color: #00d4ff;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .admin-task-stat span {
            color: #ffffff;
            font-size: 1.2rem;
            font-weight: 600;
        }

        /* Admin Tasks Controls */
        .admin-tasks-controls {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }

        .admin-tasks-controls .input-group {
            margin-bottom: 0;
        }

        @media (max-width: 768px) {
            .admin-tasks-controls {
                grid-template-columns: 1fr;
            }
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #00d4ff;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 212, 255, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid rgba(0, 212, 255, 0.3);
        }

        .modal-header h3 {
            color: #00d4ff;
            font-size: 1.5rem;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            color: #ffffff;
            font-size: 2rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #00d4ff;
        }

        .modal-body {
            padding: 20px;
        }

        /* Task Styles */
        .task-list {
            display: grid;
            gap: 20px;
            margin-top: 30px;
        }

        .task-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: 15px;
            padding: 25px;
            transition: all 0.3s ease;
        }

        .task-item:hover {
            border-color: #00d4ff;
            box-shadow: 0 5px 15px rgba(0, 212, 255, 0.2);
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .task-title {
            color: #00d4ff;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .task-priority {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .task-priority.high {
            background: rgba(255, 71, 87, 0.2);
            color: #ff4757;
            border: 1px solid #ff4757;
        }

        .task-priority.medium {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
            border: 1px solid #ffc107;
        }

        .task-priority.low {
            background: rgba(40, 167, 69, 0.2);
            color: #28a745;
            border: 1px solid #28a745;
        }

        .task-description {
            color: #cccccc;
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .task-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            color: #999999;
            flex-wrap: wrap;
            gap: 10px;
        }

        .task-week {
            background: rgba(0, 212, 255, 0.1);
            color: #00d4ff;
            padding: 3px 10px;
            border-radius: 15px;
            border: 1px solid rgba(0, 212, 255, 0.3);
        }

        .task-status {
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .task-status.active {
            background: rgba(0, 212, 255, 0.1);
            color: #00d4ff;
            border: 1px solid rgba(0, 212, 255, 0.3);
        }

        .task-status.completed {
            background: rgba(40, 167, 69, 0.2);
            color: #28a745;
            border: 1px solid #28a745;
        }

        .task-status.overdue {
            background: rgba(255, 71, 87, 0.2);
            color: #ff4757;
            border: 1px solid #ff4757;
        }

        .task-actions {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(0, 212, 255, 0.2);
        }

        .task-completed {
            margin-top: 15px;
            padding: 10px;
            background: rgba(40, 167, 69, 0.1);
            border: 1px solid #28a745;
            border-radius: 8px;
            color: #28a745;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Week Tabs */
        .weeks-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .week-tab {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(0, 212, 255, 0.3);
            border-radius: 25px;
            color: #ffffff;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .week-tab:hover {
            background: rgba(0, 212, 255, 0.1);
            border-color: #00d4ff;
        }

        .week-tab.active {
            background: #00d4ff;
            color: #000000;
            border-color: #00d4ff;
        }

        /* Incentives */
        .incentives-list {
            display: grid;
            gap: 15px;
        }

        .incentive-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .incentive-item.bonus {
            border: 1px solid rgba(40, 167, 69, 0.3);
        }

        .incentive-item.deduction {
            border: 1px solid rgba(255, 71, 87, 0.3);
        }

        .incentive-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .incentive-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .incentive-type {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .incentive-type i {
            font-size: 1.2rem;
        }

        .incentive-item.bonus .incentive-type {
            color: #28a745;
        }

        .incentive-item.deduction .incentive-type {
            color: #ff4757;
        }

        .incentive-amount {
            font-size: 1.3rem;
            font-weight: 700;
        }

        .incentive-amount.positive {
            color: #28a745;
        }

        .incentive-amount.negative {
            color: #ff4757;
        }

        .incentive-reason {
            color: #cccccc;
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .inc entive-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #999999;
        }

        /* User Info */
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            color: #ffffff;
            font-weight: 600;
        }

        .department-badge {
            background: rgba(0, 212, 255, 0.1);
            color: #00d4ff;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            border: 1px solid rgba(0, 212, 255, 0.3);
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .no-tasks,
        .no-incentives {
            text-align: center;
            color: #999999;
            font-style: italic;
            padding: 40px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 10px;
            border: 1px dashed rgba(0, 212, 255, 0.2);
        }

        /* Messages */
        .message {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1100;
            min-width: 300px;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
            animation: slideIn 0.3s ease-out;
        }

        .message.success {
            background: rgba(46, 204, 113, 0.2);
            border: 1px solid #2ecc71;
            color: #2ecc71;
        }

        .message.error {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid #e74c3c;
            color: #e74c3c;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 20px;
            }

            .welcome-content h2 {
                font-size: 2rem;
            }

            .features {
                grid-template-columns: 1fr;
            }

            .form-container {
                margin: 20px;
                padding: 30px 20px;
            }

            .dashboard-header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .admin-actions {
                grid-template-columns: 1fr;
            }

            .user-info {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }

            .weeks-tabs {
                justify-content: center;
            }

            .week-tab {
                padding: 8px 15px;
                font-size: 0.9rem;
            }

            .incentive-header {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }

            .incentive-meta {
                flex-direction: column;
                gap: 5px;
                text-align: center;
            }

            .message {
                right: 10px;
                left: 10px;
                min-width: auto;
            }

            .task-meta {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <h1><i class="fas fa-building"></i> 4AM Company</h1>
            </div>
            <nav class="nav" id="mainNav">
                <button id="loginBtn" class="btn btn-primary">تسجيل الدخول</button>
                <button id="registerBtn" class="btn btn-secondary">إنشاء حساب</button>
            </nav>
            <nav class="nav hidden" id="userNav">
                <span class="user-info" id="userInfo">
                    مرحباً، <span id="userName">المستخدم</span>
                    <span class="department-badge hidden" id="userDepartment">القسم</span>
                </span>
                <button id="logoutBtn" class="btn btn-danger">تسجيل الخروج</button>
            </nav>
        </header>
        <!-- Main Content -->
        <main class="main-content">
            <!-- Welcome Section -->
            <section id="welcomeSection" class="welcome-section">
                <div class="welcome-content">
                    <h2>مرحباً بك في نظام إدارة شركة 4AM</h2>
                    <p>نظام شامل لإدارة المهام والموظفين والحوافز</p>
                    <div class="features">
                        <div class="feature">
                            <i class="fas fa-tasks"></i>
                            <h3>إدارة المهام</h3>
                            <p>تنظيم المهام الشهرية والأسبوعية</p>
                        </div>
                        <div class="feature">
                            <i class="fas fa-users"></i>
                            <h3>إدارة الموظفين</h3>
                            <p>متابعة أداء الفريق والأقسام</p>
                        </div>
                        <div class="feature">
                            <i class="fas fa-award"></i>
                            <h3>الحوافز والخصومات</h3>
                            <p>نظام شامل للمكافآت والعقوبات</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Login Form -->
            <section id="loginSection" class="form-section hidden">
                <div class="form-container">
                    <h2><i class="fas fa-sign-in-alt"></i> تسجيل الدخول</h2>
                    <form id="loginForm">
                        <div class="input-group">
                            <label for="loginEmail">البريد الإلكتروني</label>
                            <input type="email" id="loginEmail" required>
                        </div>
                        <div class="input-group">
                            <label for="loginPassword">كلمة المرور</label>
                            <input type="password" id="loginPassword" required>
                        </div>
                        <button type="submit" class="btn btn-primary">دخول</button>
                        <p class="form-link">ليس لديك حساب؟ <a href="#" id="showRegister">إنشاء حساب جديد</a></p>
                    </form>
                </div>
            </section>

            <!-- Registration Form -->
            <section id="registerSection" class="form-section hidden">
                <div class="form-container">
                    <h2><i class="fas fa-user-plus"></i> إنشاء حساب جديد</h2>
                    <form id="registerForm">
                        <div class="input-group">
                            <label for="fullName">الاسم الكامل</label>
                            <input type="text" id="fullName" required>
                        </div>
                        <div class="input-group">
                            <label for="email">البريد الإلكتروني</label>
                            <input type="email" id="email" required>
                        </div>
                        <div class="input-group">
                            <label for="password">كلمة المرور</label>
                            <input type="password" id="password" required>
                        </div>
                        <div class="input-group">
                            <label for="confirmPassword">تأكيد كلمة المرور</label>
                            <input type="password" id="confirmPassword" required>
                        </div>
                        <div class="input-group">
                            <label for="userType">نوع المستخدم</label>
                            <select id="userType" required>
                                <option value="">اختر نوع المستخدم</option>
                                <option value="employee">موظف (Employee)</option>
                                <option value="assistant">مساعد (Assistant)</option>
                            </select>
                            <small style="color: #999; font-size: 0.85rem; display: block; margin-top: 5px;">
                                ملاحظة: حساب المدير (Admin) يُنشأ تلقائياً ولا يمكن إنشاؤه من هنا
                            </small>
                        </div>
                        <div class="input-group" id="departmentGroup" style="display: none;">
                            <label for="department">القسم</label>
                            <select id="department">
                                <option value="">اختر القسم</option>
                                <option value="photographer">Photographer</option>
                                <option value="graphic-designer">Graphic Designer</option>
                                <option value="media-buyer">Media Buyer</option>
                                <option value="account-manager">Account Manager</option>
                                <option value="montier">Montier</option>
                                <option value="content">Content</option>
                                <option value="moderator">Moderator</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">إنشاء الحساب</button>
                        <p class="form-link">لديك حساب بالفعل؟ <a href="#" id="showLogin">تسجيل الدخول</a></p>
                    </form>
                </div>
            </section>

            <!-- Admin Dashboard -->
            <section id="adminDashboard" class="dashboard hidden">
                <div class="dashboard-header">
                    <h2><i class="fas fa-crown"></i> لوحة تحكم المدير</h2>
                </div>
                <div class="dashboard-content">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <i class="fas fa-users"></i>
                            <h3>إجمالي الموظفين</h3>
                            <span id="totalEmployees">0</span>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-user-tie"></i>
                            <h3>المساعدين</h3>
                            <span id="totalAssistants">0</span>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-tasks"></i>
                            <h3>المهام النشطة</h3>
                            <span id="activeTasks">0</span>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-calendar-week"></i>
                            <h3>الأسبوع الحالي</h3>
                            <span id="currentWeek">1</span>
                        </div>
                    </div>
                    <div class="admin-actions">
                        <button class="action-btn" id="createTaskBtn">
                            <i class="fas fa-plus"></i> إنشاء مهمة جديدة
                        </button>
                        <button class="action-btn" id="manageIncentivesBtn">
                            <i class="fas fa-award"></i> إدارة الحوافز والخصومات
                        </button>
                        <button class="action-btn" id="viewReportsBtn">
                            <i class="fas fa-chart-bar"></i> التقارير والإحصائيات
                        </button>
                        <button class="action-btn" id="manageUsersBtn">
                            <i class="fas fa-users-cog"></i> إدارة المستخدمين
                        </button>
                    </div>

                    <!-- Active Tasks Section for Admin -->
                    <div class="admin-tasks-section">
                        <h3><i class="fas fa-clipboard-list"></i> المهام النشطة</h3>

                        <!-- Search and Filter -->
                        <div class="admin-tasks-controls">
                            <div class="input-group">
                                <input type="text" id="adminTaskSearch" placeholder="البحث في المهام..."
                                    style="margin-bottom: 0;">
                            </div>
                            <select id="adminTaskFilter" style="margin-bottom: 0;">
                                <option value="all">جميع الموظفين</option>
                            </select>
                        </div>

                        <!-- Quick Stats -->
                        <div class="admin-tasks-stats" id="adminTasksStats">
                            <!-- Task statistics will be loaded here -->
                        </div>

                        <div class="weeks-tabs">
                            <button class="week-tab active" data-admin-week="all" id="allWeeksTab">جميع
                                الأسابيع</button>
                            <button class="week-tab" data-admin-week="1">الأسبوع الأول</button>
                            <button class="week-tab" data-admin-week="2">الأسبوع الثاني</button>
                            <button class="week-tab" data-admin-week="3">الأسبوع الثالث</button>
                            <button class="week-tab" data-admin-week="4">الأسبوع الرابع</button>
                        </div>
                        <div id="adminActiveTasksList" class="task-list">
                            <!-- Active tasks will be loaded here -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- Assistant Dashboard -->
            <section id="assistantDashboard" class="dashboard hidden">
                <div class="dashboard-header">
                    <h2><i class="fas fa-user-tie"></i> لوحة تحكم المساعد</h2>
                    <div class="dashboard-actions">
                        <button id="createEmployeeTaskBtn" class="btn btn-primary">
                            <i class="fas fa-plus"></i> إنشاء مهمة للموظفين
                        </button>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <i class="fas fa-tasks"></i>
                        <h3>المهام المُنشأة</h3>
                        <span id="createdTasks">0</span>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-users"></i>
                        <h3>الموظفين المُكلفين</h3>
                        <span id="assignedEmployees">0</span>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-check-circle"></i>
                        <h3>المهام المكتملة</h3>
                        <span id="assistantCompletedTasks">0</span>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-calendar-week"></i>
                        <h3>الأسبوع الحالي</h3>
                        <span id="assistantCurrentWeek">1</span>
                    </div>
                </div>

                <div class="tasks-section">
                    <h3><i class="fas fa-list"></i> المهام المُنشأة</h3>
                    <div id="createdTasksList" class="task-list">
                        <!-- Tasks will be loaded here -->
                    </div>
                </div>

                <div class="tasks-section">
                    <h3><i class="fas fa-clipboard-list"></i> مهامي الشخصية</h3>
                    <div id="assistantMyTasksList" class="task-list">
                        <!-- My tasks will be loaded here -->
                    </div>
                </div>
            </section>
            <!-- Employee Dashboard -->
            <section id="employeeDashboard" class="dashboard hidden">
                <div class="dashboard-header">
                    <h2><i class="fas fa-user"></i> لوحة تحكم الموظف</h2>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <i class="fas fa-tasks"></i>
                        <h3>إجمالي المهام</h3>
                        <span id="employeeTotalTasks">0</span>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-check-circle"></i>
                        <h3>المهام المكتملة</h3>
                        <span id="employeeCompletedTasks">0</span>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-clock"></i>
                        <h3>المهام المعلقة</h3>
                        <span id="pendingTasks">0</span>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-award"></i>
                        <h3>الحوافز المكتسبة</h3>
                        <span id="totalIncentives">0</span>
                    </div>
                </div>

                <div class="weekly-tasks">
                    <h3><i class="fas fa-calendar-alt"></i> المهام الأسبوعية</h3>
                    <div class="weeks-tabs">
                        <button class="week-tab active" data-week="1">الأسبوع الأول</button>
                        <button class="week-tab" data-week="2">الأسبوع الثاني</button>
                        <button class="week-tab" data-week="3">الأسبوع الثالث</button>
                        <button class="week-tab" data-week="4">الأسبوع الرابع</button>
                    </div>
                    <div id="weeklyTasksList" class="task-list">
                        <!-- Weekly tasks will be loaded here -->
                    </div>
                </div>

                <div class="incentives-section">
                    <h3><i class="fas fa-trophy"></i> الحوافز والخصومات</h3>
                    <div id="incentivesList" class="incentives-list">
                        <!-- Incentives will be loaded here -->
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // 4AM Company Management System - Complete JavaScript

        class FourAMCompleteSystem {
            constructor() {
                this.token = localStorage.getItem('token') || null;
                this.currentUser = JSON.parse(localStorage.getItem('4am_currentUser')) || null;
                this.users = JSON.parse(localStorage.getItem('4am_users')) || [];
                this.tasks = JSON.parse(localStorage.getItem('4am_tasks')) || [];
                this.incentives = JSON.parse(localStorage.getItem('4am_incentives')) || [];
                this.currentWeek = this.getCurrentWeek();
                this.selectedWeek = 1;
                this.selectedAdminWeek = 'all';

                this.initializeAdmin();
                this.initializeEventListeners();
                this.checkCurrentUser();
                this.loadTasksFromAPI();
            }

            async loadTasksFromAPI() {
                if (this.token) {
                    try {
                        // Use /api/tasks/all for admins/assistants to see all tasks
                        // Use /api/tasks for employees to see only their assigned tasks
                        const userType = this.currentUser?.type || this.currentUser?.user_type || 'employee';
                        const endpoint = (userType === 'admin' || userType === 'assistant') ? '/api/tasks/all' : '/api/tasks';
                        
                        const response = await fetch(endpoint, {
                            headers: {
                                'Authorization': `Bearer ${this.token}`
                            }
                        });
                        if (response.ok) {
                            const data = await response.json();
                            console.log(`API ${endpoint} returned`, (data.tasks||[]).length, 'tasks');
                            const apiTasks = data.tasks || [];
                            // Map API tasks (DB shape) -> UI shape
                            this.tasks = apiTasks.map(t => ({
                                id: t.id,
                                title: t.title,
                                description: t.description || '',
                                assignedTo: t.user_id || t.assignedTo || null,
                                week: this.computeWeekFromDate(t.week_start || t.created_at),
                                priority: t.priority || 'medium',
                                status: t.status === 'completed' ? 'completed' : 'active',
                                createdBy: t.assigned_by || this.currentUser?.id || null,
                                createdAt: t.created_at,
                                completedAt: t.completed_at || null
                            }));
                            console.log('Mapped tasks for UI. My tasks count:', this.tasks.filter(t => t.assignedTo == (this.currentUser&&this.currentUser.id)).length);
                            this.saveTasks();
                        }
                    } catch (error) {
                        console.error('Error loading tasks:', error);
                    }
                }
            }

            computeWeekFromDate(dateStr) {
                try {
                    if (!dateStr) return this.getCurrentWeek();
                    const d = new Date(dateStr);
                    const startOfMonth = new Date(d.getFullYear(), d.getMonth(), 1);
                    const day = d.getDate();
                    return Math.max(1, Math.min(5, Math.ceil(day / 7)));
                } catch {
                    return this.getCurrentWeek();
                }
            }

            async initializeAdmin() {
                // Admin account is created in the database automatically
                // This is just for frontend localStorage compatibility
                const adminExists = this.users.find(user => user.type === 'admin');
                if (!adminExists) {
                    const admin = {
                        id: 'admin_001',
                        fullName: 'Mr.Mostafa Nassar - Manager',
                        email: 'admin@4am.com',
                        password: 'admin123',
                        type: 'admin',
                        department: null,
                        createdAt: new Date().toISOString()
                    };
                    this.users.push(admin);
                    this.saveUsers();
                }
            }

            getCurrentWeek() {
                const now = new Date();
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                const dayOfMonth = now.getDate();
                return Math.ceil(dayOfMonth / 7);
            }

            checkCurrentUser() {
                if (this.currentUser) {
                    this.showUserInterface();
                    this.loadUserDashboard();
                } else {
                    this.showWelcomeSection();
                }
            }

            showUserInterface() {
                document.getElementById('mainNav').classList.add('hidden');
                document.getElementById('userNav').classList.remove('hidden');
                document.getElementById('userName').textContent = this.currentUser.fullName;

                if (this.currentUser.department) {
                    document.getElementById('userDepartment').textContent = this.getDepartmentName(this.currentUser.department);
                    document.getElementById('userDepartment').classList.remove('hidden');
                }
            }

            async loadUserDashboard() {
                // Ensure type is set correctly
                const userType = this.currentUser.type || this.currentUser.user_type || 'employee';
                this.currentUser.type = userType;
                
                // Load users from database for admin/assistant only
                if (this.token && (userType === 'admin' || userType === 'assistant')) {
                    await this.fetchUsersFromAPI();
                }
                // Ensure tasks are loaded from API before rendering dashboards
                if (this.token) {
                    await this.loadTasksFromAPI();
                }
                
                switch (userType) {
                    case 'admin':
                        await this.showAdminDashboard();
                        break;
                    case 'assistant':
                        await this.showAssistantDashboard();
                        break;
                    case 'employee':
                    default:
                        this.showEmployeeDashboard();
                        break;
                }
            }

            initializeEventListeners() {
                // Navigation buttons
                document.getElementById('loginBtn').addEventListener('click', () => this.showLoginSection());
                document.getElementById('registerBtn').addEventListener('click', () => this.showRegisterSection());

                // Form toggles
                document.getElementById('showRegister').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.showRegisterSection();
                });

                document.getElementById('showLogin').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.showLoginSection();
                });

                // Forms
                document.getElementById('loginForm').addEventListener('submit', (e) => this.handleLogin(e));
                document.getElementById('registerForm').addEventListener('submit', (e) => this.handleRegister(e));

                // User type change
                document.getElementById('userType').addEventListener('change', (e) => this.handleUserTypeChange(e));

                // Logout
                document.getElementById('logoutBtn').addEventListener('click', () => this.handleLogout());

                // Admin actions
                document.getElementById('createTaskBtn').addEventListener('click', () => this.showCreateTaskModal());
                document.getElementById('manageIncentivesBtn').addEventListener('click', () => this.showIncentivesModal());
                document.getElementById('viewReportsBtn').addEventListener('click', () => this.showReportsModal());
                document.getElementById('manageUsersBtn').addEventListener('click', () => this.showUsersModal());

                // Admin week tabs for active tasks
                document.querySelectorAll('[data-admin-week]').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        this.selectAdminWeek(e.target.dataset.adminWeek);
                    });
                });

                // Admin task search and filter
                if (document.getElementById('adminTaskSearch')) {
                    document.getElementById('adminTaskSearch').addEventListener('input', () => {
                        this.loadAdminActiveTasks();
                    });
                }

                if (document.getElementById('adminTaskFilter')) {
                    document.getElementById('adminTaskFilter').addEventListener('change', () => {
                        this.loadAdminActiveTasks();
                    });
                }

                // Assistant actions
                document.getElementById('createEmployeeTaskBtn').addEventListener('click', () => this.showCreateEmployeeTaskModal());

                // Employee week tabs
                document.querySelectorAll('.week-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        this.selectWeek(parseInt(e.target.dataset.week));
                    });
                });
            }
            showWelcomeSection() {
                this.hideAllSections();
                document.getElementById('welcomeSection').classList.remove('hidden');
                document.getElementById('mainNav').classList.remove('hidden');
                document.getElementById('userNav').classList.add('hidden');
            }

            showLoginSection() {
                this.hideAllSections();
                document.getElementById('loginSection').classList.remove('hidden');
            }

            showRegisterSection() {
                this.hideAllSections();
                document.getElementById('registerSection').classList.remove('hidden');
            }

            async showAdminDashboard() {
                this.hideAllSections();
                document.getElementById('adminDashboard').classList.remove('hidden');
                
                // Load users from database first
                await this.fetchUsersFromAPI();
                
                // Then update stats and load other data
                this.updateAdminStats();
                this.loadEmployeeFilterOptions();
                this.loadAdminActiveTasks();
            }

            async showAssistantDashboard() {
                this.hideAllSections();
                document.getElementById('assistantDashboard').classList.remove('hidden');
                document.getElementById('assistantCurrentWeek').textContent = this.currentWeek;
                
                // Load users from database first
                if (this.token) {
                    await this.fetchUsersFromAPI();
                }
                
                this.updateAssistantStats();
                this.loadCreatedTasks();
                this.loadAssistantMyTasks();
            }

            showEmployeeDashboard() {
                this.hideAllSections();
                document.getElementById('employeeDashboard').classList.remove('hidden');
                // If no tasks in current selected week, auto-switch to first available week for this user
                try {
                    const myTasks = (this.tasks || []).filter(t => t.assignedTo == this.currentUser.id);
                    if (myTasks.length > 0) {
                        const hasInSelected = myTasks.some(t => parseInt(t.week) === this.selectedWeek);
                        if (!hasInSelected) {
                            const firstWeek = parseInt(myTasks[0].week) || this.currentWeek;
                            this.selectedWeek = firstWeek;
                            const targetTab = document.querySelector(`[data-week="${firstWeek}"]`);
                            if (targetTab) {
                                document.querySelectorAll('.week-tab').forEach(tab => tab.classList.remove('active'));
                                targetTab.classList.add('active');
                            }
                        }
                    }
                } catch (e) { /* noop */ }
                this.updateEmployeeStats();
                this.loadWeeklyTasks();
                this.loadIncentives();
            }

            hideAllSections() {
                const sections = ['welcomeSection', 'loginSection', 'registerSection', 'adminDashboard', 'assistantDashboard', 'employeeDashboard'];
                sections.forEach(section => {
                    document.getElementById(section).classList.add('hidden');
                });
            }

            handleUserTypeChange(e) {
                const departmentGroup = document.getElementById('departmentGroup');
                if (e.target.value === 'employee') {
                    departmentGroup.style.display = 'block';
                    document.getElementById('department').required = true;
                } else {
                    departmentGroup.style.display = 'none';
                    document.getElementById('department').required = false;
                }
            }

            async handleLogin(e) {
                e.preventDefault();

                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;

                // Check for admin login first (for backward compatibility)
                if (email === 'admin@4am.com' && password === 'admin123') {
                    try {
                        // Try to login via API first (admin might be in database)
                        const response = await fetch('/api/auth/login', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ email, password })
                        });

                        if (response.ok) {
                            const data = await response.json();
                            const token = data.token;
                            const userData = data.user;
                            
                            localStorage.setItem('token', token);
                            localStorage.setItem('4am_currentUser', JSON.stringify({
                                id: userData.id,
                                email: userData.email,
                                name: userData.name,
                                fullName: userData.name || 'Mr.Mostafa Nassar - Manager',
                                type: userData.user_type || 'admin',
                                department: userData.department || null
                            }));

                            this.token = token;
                            this.currentUser = JSON.parse(localStorage.getItem('4am_currentUser'));
                            this.showUserInterface();
                            this.loadUserDashboard();
                            this.loadTasksFromAPI();
                            this.showMessage('تم تسجيل الدخول بنجاح', 'success');
                            return;
                        }
                    } catch (err) {
                        // Fall through to admin login fallback
                    }
                }

                try {
                    // Call backend API for login
                    const response = await fetch('/api/auth/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ email, password })
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        this.showMessage(data.error || 'بيانات الدخول غير صحيحة', 'error');
                        return;
                    }

                    // Store token and user data
                    const token = data.token;
                    const userData = data.user;
                    
                    localStorage.setItem('token', token);
                    localStorage.setItem('4am_currentUser', JSON.stringify({
                        id: userData.id,
                        email: userData.email,
                        name: userData.name,
                        fullName: userData.name || userData.email,
                        type: userData.user_type || 'employee',
                        department: userData.department || null
                    }));

                    this.token = token;
                    this.currentUser = JSON.parse(localStorage.getItem('4am_currentUser'));
                    this.showUserInterface();
                    this.loadUserDashboard();
                    this.loadTasksFromAPI();
                    this.showMessage('تم تسجيل الدخول بنجاح', 'success');
                } catch (error) {
                    console.error('Login error:', error);
                    this.showMessage('حدث خطأ أثناء تسجيل الدخول', 'error');
                }
            }
            async handleRegister(e) {
                e.preventDefault();

                const formData = {
                    name: document.getElementById('fullName').value,
                    email: document.getElementById('email').value,
                    password: document.getElementById('password').value,
                    confirmPassword: document.getElementById('confirmPassword').value,
                    userType: document.getElementById('userType').value,
                    department: document.getElementById('department').value
                };

                // Validation
                if (formData.password !== formData.confirmPassword) {
                    this.showMessage('كلمات المرور غير متطابقة', 'error');
                    return;
                }

                if (formData.password.length < 6) {
                    this.showMessage('كلمة المرور يجب أن تكون 6 أحرف على الأقل', 'error');
                    return;
                }

                try {
                    // Call backend API for registration
                    const response = await fetch('/api/auth/register', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            name: formData.name,
                            email: formData.email,
                            password: formData.password,
                            user_type: formData.userType || 'employee',
                            department: formData.department || null
                        })
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        this.showMessage(data.error || 'فشل إنشاء الحساب', 'error');
                        return;
                    }

                    // Store token and user data
                    const token = data.token;
                    const userData = data.user;
                    
                    localStorage.setItem('token', token);
                    localStorage.setItem('4am_currentUser', JSON.stringify({
                        id: userData.id,
                        email: userData.email,
                        name: userData.name,
                        fullName: userData.name || userData.email,
                        type: userData.user_type || 'employee',
                        department: userData.department || formData.department || null
                    }));

                    this.token = token;
                    this.showMessage('تم إنشاء الحساب بنجاح', 'success');
                    setTimeout(() => {
                        this.currentUser = JSON.parse(localStorage.getItem('4am_currentUser'));
                        this.showUserInterface();
                        this.loadUserDashboard();
                        this.loadTasksFromAPI();
                    }, 1000);
                } catch (error) {
                    console.error('Registration error:', error);
                    this.showMessage('حدث خطأ أثناء إنشاء الحساب', 'error');
                }
            }

            handleLogout() {
                this.currentUser = null;
                this.token = null;
                localStorage.removeItem('4am_currentUser');
                localStorage.removeItem('token');
                this.showWelcomeSection();
                this.showMessage('تم تسجيل الخروج بنجاح', 'success');
            }

            // Admin Dashboard Methods
            async updateAdminStats() {
                if (!this.token) {
                    console.warn('No token available for updateAdminStats');
                    return;
                }
                
                try {
                    // Fetch user statistics from API
                    console.log('Fetching user stats from /api/auth/stats');
                    const response = await fetch('/api/auth/stats', {
                        headers: {
                            'Authorization': `Bearer ${this.token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    console.log('Stats API response status:', response.status);
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('Stats API data:', data);
                        const stats = data.stats || { employees: 0, assistants: 0, admins: 0, total: 0 };
                        
                        const employeesEl = document.getElementById('totalEmployees');
                        const assistantsEl = document.getElementById('totalAssistants');
                        
                        if (employeesEl) {
                            employeesEl.textContent = stats.employees || 0;
                            console.log('Updated totalEmployees to:', stats.employees);
                        } else {
                            console.error('Element totalEmployees not found');
                        }
                        
                        if (assistantsEl) {
                            assistantsEl.textContent = stats.assistants || 0;
                            console.log('Updated totalAssistants to:', stats.assistants);
                        } else {
                            console.error('Element totalAssistants not found');
                        }
                    } else {
                        const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                        console.error('Stats API error:', response.status, errorData);
                        
                        // Fallback to 0 if API call fails
                        const employeesEl = document.getElementById('totalEmployees');
                        const assistantsEl = document.getElementById('totalAssistants');
                        if (employeesEl) employeesEl.textContent = 0;
                        if (assistantsEl) assistantsEl.textContent = 0;
                    }
                } catch (error) {
                    console.error('Error loading user stats:', error);
                    const employeesEl = document.getElementById('totalEmployees');
                    const assistantsEl = document.getElementById('totalAssistants');
                    if (employeesEl) employeesEl.textContent = 0;
                    if (assistantsEl) assistantsEl.textContent = 0;
                }
                
                // Load tasks count from local storage or API
                const activeTasks = this.tasks.filter(t => t.status === 'active');
                const activeTasksEl = document.getElementById('activeTasks');
                if (activeTasksEl) activeTasksEl.textContent = activeTasks.length;
                
                const currentWeekEl = document.getElementById('currentWeek');
                if (currentWeekEl) currentWeekEl.textContent = this.currentWeek;
            }

            selectAdminWeek(week) {
                this.selectedAdminWeek = week;

                // Update active tab
                document.querySelectorAll('[data-admin-week]').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelector(`[data-admin-week="${week}"]`).classList.add('active');

                // Load tasks for selected week
                this.loadAdminActiveTasks();
            }

            async loadEmployeeFilterOptions() {
                const filterSelect = document.getElementById('adminTaskFilter');
                if (!filterSelect || !this.token) return;

                try {
                    // Use the fetchUsersFromAPI method which handles caching
                    const users = await this.fetchUsersFromAPI();

                    const employees = users.filter(u => (u.user_type || u.type) === 'employee');
                    const assistants = users.filter(u => (u.user_type || u.type) === 'assistant');

                    let options = '<option value="all">جميع الموظفين</option>';

                    employees.forEach(emp => {
                        const name = emp.name || emp.fullName || emp.email;
                        const dept = emp.department || '';
                        options += `<option value="${emp.id}">${name}${dept ? ' (' + this.getDepartmentName(dept) + ')' : ''}</option>`;
                    });

                    assistants.forEach(ass => {
                        const name = ass.name || ass.fullName || ass.email;
                        options += `<option value="${ass.id}">${name} (مساعد)</option>`;
                    });

                    filterSelect.innerHTML = options;
                } catch (error) {
                    console.error('Error loading employee filter options:', error);
                    // Fallback to empty options
                    filterSelect.innerHTML = '<option value="all">جميع الموظفين</option>';
                }
            }

            loadAdminActiveTasks() {
                let activeTasks = this.tasks.filter(t => t.status === 'active');

                // Filter by week if not "all"
                if (this.selectedAdminWeek !== 'all') {
                    activeTasks = activeTasks.filter(t => parseInt(t.week) === parseInt(this.selectedAdminWeek));
                }

                // Filter by employee
                const employeeFilter = document.getElementById('adminTaskFilter');
                if (employeeFilter && employeeFilter.value !== 'all') {
                    activeTasks = activeTasks.filter(t => t.assignedTo === employeeFilter.value);
                }

                // Filter by search term
                const searchTerm = document.getElementById('adminTaskSearch');
                if (searchTerm && searchTerm.value.trim()) {
                    const term = searchTerm.value.trim().toLowerCase();
                    activeTasks =                     activeTasks.filter(t => {
                        const assignedUser = this.users.find(u => u.id === t.assignedTo || u.id == t.assignedTo);
                        const createdBy = this.users.find(u => u.id === t.createdBy || u.id == t.createdBy);
                        
                        const assignedName = assignedUser ? (assignedUser.name || assignedUser.fullName || assignedUser.email || '').toLowerCase() : '';
                        const createdByName = createdBy ? (createdBy.name || createdBy.fullName || createdBy.email || '').toLowerCase() : '';

                        return t.title.toLowerCase().includes(term) ||
                            t.description.toLowerCase().includes(term) ||
                            assignedName.includes(term) ||
                            createdByName.includes(term);
                    });
                }

                // Update quick stats
                this.updateAdminTasksStats(activeTasks);

                const tasksList = document.getElementById('adminActiveTasksList');

                if (activeTasks.length === 0) {
                    const weekText = this.selectedAdminWeek === 'all' ? 'جميع الأسابيع' : `الأسبوع ${this.selectedAdminWeek}`;
                    tasksList.innerHTML = `<p class="no-tasks">لا توجد مهام نشطة في ${weekText}</p>`;
                    return;
                }

                tasksList.innerHTML = activeTasks.map(task => this.createAdminTaskHTML(task)).join('');
            }

            updateAdminTasksStats(activeTasks) {
                const statsContainer = document.getElementById('adminTasksStats');

                // Count tasks by priority
                const highPriority = activeTasks.filter(t => t.priority === 'high').length;
                const mediumPriority = activeTasks.filter(t => t.priority === 'medium').length;
                const lowPriority = activeTasks.filter(t => t.priority === 'low').length;

                // Count tasks by employee
                const employeeTaskCounts = {};
                activeTasks.forEach(task => {
                    const user = this.users.find(u => u.id === task.assignedTo || u.id == task.assignedTo);
                    if (user) {
                        const key = user.name || user.fullName || user.email || 'غير محدد';
                        employeeTaskCounts[key] = (employeeTaskCounts[key] || 0) + 1;
                    }
                });

                let statsHTML = `
                    <div class="admin-task-stat">
                        <h4>إجمالي المهام</h4>
                        <span>${activeTasks.length}</span>
                    </div>
                    <div class="admin-task-stat">
                        <h4>أولوية عالية</h4>
                        <span style="color: #ff4757;">${highPriority}</span>
                    </div>
                    <div class="admin-task-stat">
                        <h4>أولوية متوسطة</h4>
                        <span style="color: #ffc107;">${mediumPriority}</span>
                    </div>
                    <div class="admin-task-stat">
                        <h4>أولوية منخفضة</h4>
                        <span style="color: #28a745;">${lowPriority}</span>
                    </div>
                `;

                // Add employee task counts
                Object.entries(employeeTaskCounts).forEach(([employeeName, count]) => {
                    statsHTML += `
                        <div class="admin-task-stat">
                            <h4>${employeeName}</h4>
                            <span>${count} مهمة</span>
                        </div>
                    `;
                });

                statsContainer.innerHTML = statsHTML;
            }

            createAdminTaskHTML(task) {
                const assignedUser = this.users.find(u => u.id === task.assignedTo || u.id == task.assignedTo);
                const createdBy = this.users.find(u => u.id === task.createdBy || u.id == task.createdBy);
                
                const assignedUserName = assignedUser ? (assignedUser.name || assignedUser.fullName || assignedUser.email || 'غير محدد') : 'غير محدد';
                const createdByName = createdBy ? (createdBy.name || createdBy.fullName || createdBy.email || 'غير محدد') : 'غير محدد';

                return `
                    <div class="task-item">
                        <div class="task-header">
                            <h4 class="task-title">${task.title}</h4>
                            <span class="task-priority ${task.priority}">${this.getPriorityText(task.priority)}</span>
                        </div>
                        <p class="task-description">${task.description}</p>
                        <div class="task-meta">
                            <span class="task-week">الأسبوع ${task.week}</span>
                            <span><strong>الموظف المسؤول:</strong> ${assignedUserName}</span>
                            ${assignedUser && assignedUser.department ? `<span><strong>القسم:</strong> ${this.getDepartmentName(assignedUser.department)}</span>` : ''}
                            <span><strong>أُنشئت بواسطة:</strong> ${createdByName}</span>
                            <span><strong>تاريخ الإنشاء:</strong> ${new Date(task.createdAt).toLocaleDateString('ar-EG')}</span>
                            <span class="task-status ${task.status}">${this.getStatusText(task.status)}</span>
                        </div>
                        <div class="task-actions">
                            <button class="btn btn-secondary" onclick="system.viewTaskDetails('${task.id}')">
                                <i class="fas fa-eye"></i> عرض التفاصيل
                            </button>
                            <button class="btn btn-danger" onclick="system.deleteTask('${task.id}')">
                                <i class="fas fa-trash"></i> حذف المهمة
                            </button>
                        </div>
                    </div>
                `;
            }

            async viewTaskDetails(taskId) {
                // Find locally (coerce id equality), fallback to API for admin
                let task = this.tasks.find(t => t.id == taskId);
                let assignedUserName = 'غير محدد';
                let createdByName = 'غير محدد';

                if (this.token) {
                    try {
                        // Attempt to enrich via API (admin authorized)
                        const resp = await fetch(`/api/tasks/${taskId}`, { headers: { 'Authorization': `Bearer ${this.token}` } });
                        if (resp.ok) {
                            const j = await resp.json();
                            const tt = j.task;
                            task = task || {
                                id: tt.id,
                                title: tt.title,
                                description: tt.description || '',
                                assignedTo: tt.user_id,
                                week: this.computeWeekFromDate(tt.week_start || tt.created_at),
                                priority: 'medium',
                                status: tt.status === 'completed' ? 'completed' : 'active',
                                createdBy: tt.assigned_by,
                                createdAt: tt.created_at,
                                completedAt: tt.completed_at || null
                            };
                            assignedUserName = tt.user_name || assignedUserName;
                            createdByName = tt.assigned_by_name || createdByName;
                        }
                    } catch {}
                }

                if (!task) return;

                // Resolve names from local users if still unknown
                if (assignedUserName === 'غير محدد') {
                    const assignedUser = this.users.find(u => u.id === task.assignedTo || u.id == task.assignedTo);
                    if (assignedUser) assignedUserName = assignedUser.name || assignedUser.fullName || assignedUser.email || 'غير محدد';
                }
                if (createdByName === 'غير محدد') {
                    const createdBy = this.users.find(u => u.id === task.createdBy || u.id == task.createdBy);
                    if (createdBy) createdByName = createdBy.name || createdBy.fullName || createdBy.email || 'غير محدد';
                }

                this.createModal('تفاصيل المهمة', `
                    <div class="task-details">
                        <h4>${task.title}</h4>
                        <p><strong>الوصف:</strong> ${task.description}</p>
                        <p><strong>الموظف المسؤول:</strong> ${assignedUserName}</p>
                        <p><strong>الأسبوع:</strong> ${task.week}</p>
                        <p><strong>الأولوية:</strong> ${this.getPriorityText(task.priority)}</p>
                        <p><strong>الحالة:</strong> ${this.getStatusText(task.status)}</p>
                        <p><strong>أُنشئت بواسطة:</strong> ${createdByName}</p>
                        <p><strong>تاريخ الإنشاء:</strong> ${new Date(task.createdAt).toLocaleDateString('ar-EG')}</p>
                        ${task.completedAt ? `<p><strong>تاريخ الإنجاز:</strong> ${new Date(task.completedAt).toLocaleDateString('ar-EG')}</p>` : ''}
                    </div>
                `);
            }

            async deleteTask(taskId) {
                if (!confirm('هل أنت متأكد من حذف هذه المهمة؟')) return;
                try {
                    if (!this.token) { this.showMessage('غير مصرح', 'error'); return; }
                    const resp = await fetch(`/api/tasks/${taskId}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${this.token}` } });
                    if (!resp.ok) {
                        const j = await resp.json().catch(()=>({}));
                        this.showMessage(j.error || 'فشل حذف المهمة', 'error');
                        return;
                    }
                    // Refresh tasks from API to sync all views
                    await this.loadTasksFromAPI();
                    this.showMessage('تم حذف المهمة بنجاح', 'success');
                    this.updateAdminStats();
                    this.loadAdminActiveTasks();
                    if (this.currentUser.type === 'employee') {
                        this.updateEmployeeStats();
                        this.loadWeeklyTasks();
                    }
                } catch (e) {
                    console.error('Delete task error:', e);
                    this.showMessage('حدث خطأ أثناء حذف المهمة', 'error');
                }
            }

            async showCreateTaskModal() {
                // Show modal with loading users
                const modal = this.createModal('إنشاء مهمة جديدة', `
                    <form id="createTaskForm">
                        <div class="input-group">
                            <label for="taskTitle">عنوان المهمة</label>
                            <input type="text" id="taskTitle" required>
                        </div>
                        <div class="input-group">
                            <label for="taskDescription">وصف المهمة</label>
                            <textarea id="taskDescription" rows="4" required></textarea>
                        </div>
                        <div class="input-group">
                            <label for="assignTo">تعيين إلى</label>
                            <select id="assignTo" required>
                                <option value="">جاري تحميل المستخدمين...</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="taskWeek">الأسبوع</label>
                            <select id="taskWeek" required>
                                <option value="1">الأسبوع الأول</option>
                                <option value="2">الأسبوع الثاني</option>
                                <option value="3">الأسبوع الثالث</option>
                                <option value="4">الأسبوع الرابع</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="taskPriority">الأولوية</label>
                            <select id="taskPriority" required>
                                <option value="low">منخفضة</option>
                                <option value="medium">متوسطة</option>
                                <option value="high">عالية</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">إنشاء المهمة</button>
                    </form>
                `);

                // Load users and populate dropdown
                try {
                    const userOptions = await this.getUserOptions();
                    const assignToSelect = document.getElementById('assignTo');
                    if (assignToSelect) {
                        assignToSelect.innerHTML = '<option value="">اختر المستخدم</option>' + userOptions;
                    }
                } catch (error) {
                    console.error('Error loading user options:', error);
                    const assignToSelect = document.getElementById('assignTo');
                    if (assignToSelect) {
                        assignToSelect.innerHTML = '<option value="">حدث خطأ أثناء تحميل المستخدمين</option>';
                    }
                }

                document.getElementById('createTaskForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.createTask(e);
                    this.closeModal(modal);
                });
            }
            async showIncentivesModal() {
                // Show modal with loading users
                const modal = this.createModal('إدارة الحوافز والخصومات', `
                    <form id="incentiveForm">
                        <div class="input-group">
                            <label for="incentiveUser">الموظف</label>
                            <select id="incentiveUser" required>
                                <option value="">جاري تحميل الموظفين...</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="incentiveType">النوع</label>
                            <select id="incentiveType" required>
                                <option value="bonus">حافز</option>
                                <option value="deduction">خصم</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="incentiveAmount">المبلغ</label>
                            <input type="number" id="incentiveAmount" required>
                        </div>
                        <div class="input-group">
                            <label for="incentiveReason">السبب</label>
                            <textarea id="incentiveReason" rows="3" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">إضافة</button>
                    </form>
                `);

                // Load employees and populate dropdown
                try {
                    const employeeOptions = await this.getEmployeeOptions();
                    const incentiveUserSelect = document.getElementById('incentiveUser');
                    if (incentiveUserSelect) {
                        incentiveUserSelect.innerHTML = '<option value="">اختر الموظف</option>' + employeeOptions;
                    }
                } catch (error) {
                    console.error('Error loading employee options:', error);
                    const incentiveUserSelect = document.getElementById('incentiveUser');
                    if (incentiveUserSelect) {
                        incentiveUserSelect.innerHTML = '<option value="">حدث خطأ أثناء تحميل الموظفين</option>';
                    }
                }

                document.getElementById('incentiveForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addIncentive(e);
                    this.closeModal(modal);
                });
            }

            showReportsModal() {
                const modal = this.createModal('التقارير والإحصائيات', `
                    <div class="reports-content">
                        <h3>إحصائيات الأداء</h3>
                        <div class="report-stats">
                            <div class="report-item">
                                <span>إجمالي المهام المكتملة:</span>
                                <strong>${this.tasks.filter(t => t.status === 'completed').length}</strong>
                            </div>
                            <div class="report-item">
                                <span>المهام المتأخرة:</span>
                                <strong>${this.tasks.filter(t => t.status === 'overdue').length}</strong>
                            </div>
                            <div class="report-item">
                                <span>إجمالي الحوافز:</span>
                                <strong>${this.incentives.filter(i => i.type === 'bonus').length}</strong>
                            </div>
                            <div class="report-item">
                                <span>إجمالي الخصومات:</span>
                                <strong>${this.incentives.filter(i => i.type === 'deduction').length}</strong>
                            </div>
                        </div>
                    </div>
                `);
            }

            async showUsersModal() {
                // Show loading message first
                const modal = this.createModal('إدارة المستخدمين', `
                    <div class="users-content">
                        <h3>قائمة المستخدمين</h3>
                        <div class="users-list" id="usersListContent">
                            <p>جاري تحميل المستخدمين...</p>
                        </div>
                    </div>
                `);

                // Fetch and display users
                try {
                    const usersList = await this.getUsersList();
                    const usersListContent = document.getElementById('usersListContent');
                    if (usersListContent) {
                        usersListContent.innerHTML = usersList || '<p>لا يوجد مستخدمين</p>';
                    }
                } catch (error) {
                    console.error('Error loading users list:', error);
                    const usersListContent = document.getElementById('usersListContent');
                    if (usersListContent) {
                        usersListContent.innerHTML = '<p>حدث خطأ أثناء تحميل المستخدمين</p>';
                    }
                }
            }

            async createTask(e) {
                const taskData = {
                    title: document.getElementById('taskTitle').value,
                    description: document.getElementById('taskDescription').value
                };

                if (!this.token) {
                    this.showMessage('يجب تسجيل الدخول أولاً', 'error');
                    return;
                }

                try {
                    const response = await fetch('/api/tasks', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.token}`
                        },
                        body: JSON.stringify(taskData)
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        this.showMessage(data.error || 'فشل إنشاء المهمة', 'error');
                        return;
                    }

                    // Add task to local array for UI
                    const task = {
                        id: data.task.id,
                        title: data.task.title,
                        description: data.task.description,
                        assignedTo: document.getElementById('assignTo')?.value || null,
                        week: document.getElementById('taskWeek')?.value || 1,
                        priority: document.getElementById('taskPriority')?.value || 'medium',
                        status: 'active',
                        createdBy: this.currentUser.id,
                        createdAt: data.task.created_at
                    };

                    this.tasks.push(task);
                    this.saveTasks();
                    this.showMessage('تم إنشاء المهمة بنجاح', 'success');
                    this.updateAdminStats();
                    this.loadAdminActiveTasks();
                    this.loadTasksFromAPI();
                } catch (error) {
                    console.error('Error creating task:', error);
                    this.showMessage('حدث خطأ أثناء إنشاء المهمة', 'error');
                }
            }

            addIncentive(e) {
                const incentive = {
                    id: this.generateId(),
                    userId: document.getElementById('incentiveUser').value,
                    type: document.getElementById('incentiveType').value,
                    amount: document.getElementById('incentiveAmount').value,
                    reason: document.getElementById('incentiveReason').value,
                    createdBy: this.currentUser.id,
                    createdAt: new Date().toISOString()
                };

                this.incentives.push(incentive);
                this.saveIncentives();
                this.showMessage('تم إضافة الحافز/الخصم بنجاح', 'success');
            }
            // Assistant Dashboard Methods
            updateAssistantStats() {
                const createdTasks = this.tasks.filter(t => t.createdBy == this.currentUser.id);
                const assignedEmployees = new Set(createdTasks.map(t => t.assignedTo)).size;
                const completedTasks = createdTasks.filter(t => t.status === 'completed');

                document.getElementById('createdTasks').textContent = createdTasks.length;
                document.getElementById('assignedEmployees').textContent = assignedEmployees;
                document.getElementById('assistantCompletedTasks').textContent = completedTasks.length;
            }

            loadCreatedTasks() {
                const createdTasks = this.tasks.filter(t => t.createdBy === this.currentUser.id);
                const tasksList = document.getElementById('createdTasksList');

                if (createdTasks.length === 0) {
                    tasksList.innerHTML = '<p class="no-tasks">لا توجد مهام منشأة بعد</p>';
                    return;
                }

                tasksList.innerHTML = createdTasks.map(task => this.createTaskHTML(task)).join('');
            }

            loadAssistantMyTasks() {
                const myTasks = this.tasks.filter(t => t.assignedTo == this.currentUser.id);
                const myTasksList = document.getElementById('assistantMyTasksList');

                if (myTasks.length === 0) {
                    myTasksList.innerHTML = '<p class="no-tasks">لا توجد مهام مُكلف بها</p>';
                    return;
                }

                myTasksList.innerHTML = myTasks.map(task => this.createTaskHTML(task, true)).join('');
            }

            async showEmployeePage(employeeId, employeeName) {
                // Store selected employee for task creation
                this.selectedEmployeeId = employeeId;
                this.selectedEmployeeName = employeeName;
                
                // Show employee page with their tasks and ability to create tasks
                const modal = this.createModal(`صفحة الموظف: ${employeeName}`, `
                    <div class="employee-page-content">
                        <div class="employee-info-section" style="margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px;">
                            <h3 style="color: #00d4ff; margin-bottom: 10px;">${employeeName}</h3>
                            <p style="color: #ccc;">الموظف المسؤول</p>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <button id="createTaskForEmployeeBtn" class="btn btn-primary" style="width: 100%;">
                                <i class="fas fa-plus"></i> إنشاء مهمة جديدة
                            </button>
                        </div>
                        <div id="employeeTasksList" class="task-list">
                            <p>جاري تحميل مهام الموظف...</p>
                        </div>
                    </div>
                `);

                // Load employee tasks
                try {
                    const employeeTasks = this.tasks.filter(t => t.assignedTo == employeeId);
                    const tasksList = document.getElementById('employeeTasksList');
                    if (tasksList) {
                        if (employeeTasks.length === 0) {
                            tasksList.innerHTML = '<p class="no-tasks">لا توجد مهام لهذا الموظف</p>';
                        } else {
                            tasksList.innerHTML = employeeTasks.map(task => this.createTaskHTML(task, true)).join('');
                        }
                    }
                } catch (error) {
                    console.error('Error loading employee tasks:', error);
                }

                // Add event listener for create task button
                document.getElementById('createTaskForEmployeeBtn').addEventListener('click', () => {
                    this.closeModal(modal);
                    this.showCreateEmployeeTaskModal(employeeId, employeeName);
                });
            }

            async showCreateEmployeeTaskModal(selectedEmployeeId = null, selectedEmployeeName = null) {
                // Show modal with loading employees
                const modal = this.createModal('إنشاء مهمة للموظفين', `
                    <form id="createEmployeeTaskForm">
                        <div class="input-group">
                            <label for="empTaskTitle">عنوان المهمة</label>
                            <input type="text" id="empTaskTitle" required>
                        </div>
                        <div class="input-group">
                            <label for="empTaskDescription">وصف المهمة</label>
                            <textarea id="empTaskDescription" rows="4" required></textarea>
                        </div>
                        <div class="input-group">
                            <label for="empAssignTo">تعيين إلى الموظف</label>
                            <select id="empAssignTo" required>
                                <option value="">جاري تحميل الموظفين...</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="empTaskWeek">الأسبوع</label>
                            <select id="empTaskWeek" required>
                                <option value="1">الأسبوع الأول</option>
                                <option value="2">الأسبوع الثاني</option>
                                <option value="3">الأسبوع الثالث</option>
                                <option value="4">الأسبوع الرابع</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="empTaskPriority">الأولوية</label>
                            <select id="empTaskPriority" required>
                                <option value="low">منخفضة</option>
                                <option value="medium" selected>متوسطة</option>
                                <option value="high">عالية</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">إنشاء المهمة</button>
                    </form>
                `);

                // Load employees and populate dropdown
                try {
                    const employeeOptions = await this.getEmployeeOptions();
                    const empAssignToSelect = document.getElementById('empAssignTo');
                    if (empAssignToSelect) {
                        empAssignToSelect.innerHTML = '<option value="">اختر الموظف</option>' + employeeOptions;
                        // Pre-select the employee if provided
                        if (selectedEmployeeId) {
                            empAssignToSelect.value = selectedEmployeeId;
                        }
                    }
                } catch (error) {
                    console.error('Error loading employee options:', error);
                    const empAssignToSelect = document.getElementById('empAssignTo');
                    if (empAssignToSelect) {
                        empAssignToSelect.innerHTML = '<option value="">حدث خطأ أثناء تحميل الموظفين</option>';
                    }
                }

                document.getElementById('createEmployeeTaskForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.createEmployeeTask(e);
                    this.closeModal(modal);
                });
            }

            getWeekStartDateFromSelection(weekNumber) {
                const now = new Date();
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                const date = new Date(startOfMonth);
                date.setDate(startOfMonth.getDate() + (Number(weekNumber) - 1) * 7);
                // Normalize to YYYY-MM-DD
                const yyyy = date.getFullYear();
                const mm = String(date.getMonth() + 1).padStart(2, '0');
                const dd = String(date.getDate()).padStart(2, '0');
                return `${yyyy}-${mm}-${dd}`;
            }

            async createEmployeeTask(e) {
                const title = document.getElementById('empTaskTitle').value;
                const description = document.getElementById('empTaskDescription').value;
                const user_id = document.getElementById('empAssignTo').value;
                const week = document.getElementById('empTaskWeek').value;
                const priority = document.getElementById('empTaskPriority').value;
                const week_start = this.getWeekStartDateFromSelection(week);

                if (!this.token) {
                    this.showMessage('يجب تسجيل الدخول أولاً', 'error');
                    return;
                }

                try {
                    // Call backend to persist
                    const response = await fetch('/api/tasks/assign', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.token}`
                        },
                        body: JSON.stringify({ user_id: Number(user_id), title, description, week_start, priority })
                    });
                    const data = await response.json();
                    if (!response.ok) {
                        this.showMessage(data.error || 'فشل إنشاء المهمة', 'error');
                        return;
                    }

                    // Update UI model from API response
                    const t = data.task;
                    const task = {
                        id: t.id,
                        title: t.title,
                        description: t.description || '',
                        assignedTo: t.user_id || user_id,
                        week: this.computeWeekFromDate(t.week_start || week_start),
                        priority: t.priority || priority || 'medium',
                        status: t.status === 'completed' ? 'completed' : 'active',
                        createdBy: t.assigned_by || this.currentUser.id,
                        createdAt: t.created_at,
                        completedAt: t.completed_at || null
                    };
                    this.tasks.push(task);
                    this.saveTasks();
                    this.showMessage('تم إنشاء المهمة بنجاح', 'success');
                    this.updateAssistantStats();
                    this.loadCreatedTasks();
                    this.updateAdminStats();
                    this.loadAdminActiveTasks();
                    // Reload tasks from API to get updated data
                    await this.loadTasksFromAPI();
                } catch (error) {
                    console.error('Error creating employee task:', error);
                    this.showMessage('حدث خطأ أثناء إنشاء المهمة', 'error');
                }
            }

            selectWeek(week) {
                this.selectedWeek = week;

                // Update active tab (guard against missing element)
                document.querySelectorAll('.week-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                const targetTab = document.querySelector(`[data-week="${week}"]`);
                if (targetTab) targetTab.classList.add('active');

                // Load tasks for selected week
                this.loadWeeklyTasks();
            }

            async updateTaskStatus(taskId, status) {
                const token = this.token;
                if (!token) {
                    this.showMessage('يجب تسجيل الدخول أولاً', 'error');
                    return;
                }
                try {
                    const resp = await fetch(`/api/tasks/${taskId}/status`, {
                        method: 'PATCH',
                        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status })
                    });
                    if (!resp.ok) {
                        const j = await resp.json().catch(()=>({}));
                        this.showMessage(j.error || 'فشل تحديث الحالة', 'error');
                        return;
                    }
                    await this.loadTasksFromAPI();
                    if (this.currentUser.type === 'employee') {
                        this.updateEmployeeStats();
                        this.loadWeeklyTasks();
                    } else if (this.currentUser.type === 'assistant') {
                        this.updateAssistantStats();
                        this.loadAssistantMyTasks();
                    }
                    this.updateAdminStats();
                    if (document.getElementById('adminDashboard') && !document.getElementById('adminDashboard').classList.contains('hidden')) {
                        this.loadAdminActiveTasks();
                    }
                    this.showMessage('تم تحديث حالة المهمة', 'success');
                } catch (e) {
                    console.error('Update status error:', e);
                    this.showMessage('حدث خطأ أثناء تحديث الحالة', 'error');
                }
            }

            markTaskCompleted(taskId) {
                this.updateTaskStatus(taskId, 'completed');
            }
            // Employee Dashboard Methods
            updateEmployeeStats() {
                const myTasks = this.tasks.filter(t => t.assignedTo == this.currentUser.id);
                const completedTasks = myTasks.filter(t => t.status === 'completed');
                const pendingTasks = myTasks.filter(t => t.status === 'active');
                const myIncentives = this.incentives.filter(i => i.userId === this.currentUser.id);

                document.getElementById('employeeTotalTasks').textContent = myTasks.length;
                document.getElementById('employeeCompletedTasks').textContent = completedTasks.length;
                document.getElementById('pendingTasks').textContent = pendingTasks.length;
                document.getElementById('totalIncentives').textContent = myIncentives.length;
            }

            loadWeeklyTasks() {
                const weeklyTasks = this.tasks.filter(t =>
                    t.assignedTo == this.currentUser.id &&
                    parseInt(t.week) === this.selectedWeek
                );

                const tasksList = document.getElementById('weeklyTasksList');

                if (weeklyTasks.length === 0) {
                    tasksList.innerHTML = `<p class="no-tasks">لا توجد مهام للأسبوع ${this.selectedWeek}</p>`;
                    return;
                }

                tasksList.innerHTML = weeklyTasks.map(task => this.createTaskHTML(task, true)).join('');
            }

            loadIncentives() {
                const myIncentives = this.incentives.filter(i => i.userId === this.currentUser.id);
                const incentivesList = document.getElementById('incentivesList');

                if (myIncentives.length === 0) {
                    incentivesList.innerHTML = '<p class="no-incentives">لا توجد حوافز أو خصومات بعد</p>';
                    return;
                }

                incentivesList.innerHTML = myIncentives.map(incentive => this.createIncentiveHTML(incentive)).join('');
            }

            createIncentiveHTML(incentive) {
                const createdBy = this.users.find(u => u.id === incentive.createdBy || u.id == incentive.createdBy);
                const createdByName = createdBy ? (createdBy.name || createdBy.fullName || createdBy.email || 'غير محدد') : 'غير محدد';
                const isBonus = incentive.type === 'bonus';

                return `
                    <div class="incentive-item ${incentive.type}">
                        <div class="incentive-header">
                            <div class="incentive-type">
                                <i class="fas ${isBonus ? 'fa-award' : 'fa-minus-circle'}"></i>
                                <span>${isBonus ? 'حافز' : 'خصم'}</span>
                            </div>
                            <div class="incentive-amount ${isBonus ? 'positive' : 'negative'}">
                                ${isBonus ? '+' : '-'}${incentive.amount}
                            </div>
                        </div>
                        <p class="incentive-reason">${incentive.reason}</p>
                        <div class="incentive-meta">
                            <span>من: ${createdByName}</span>
                            <span>${new Date(incentive.createdAt).toLocaleDateString('ar-EG')}</span>
                        </div>
                    </div>
                `;
            }

            // Common Methods
            createTaskHTML(task, isMyTask = false) {
                const assignedUser = this.users.find(u => u.id === task.assignedTo || u.id == task.assignedTo);
                const createdBy = this.users.find(u => u.id === task.createdBy || u.id == task.createdBy);
                
                const assignedUserName = assignedUser ? (assignedUser.name || assignedUser.fullName || assignedUser.email || 'غير محدد') : 'غير محدد';
                const createdByName = createdBy ? (createdBy.name || createdBy.fullName || createdBy.email || 'غير محدد') : 'غير محدد';

                return `
                    <div class="task-item">
                        <div class="task-header">
                            <h4 class="task-title">${task.title}</h4>
                            <span class="task-priority ${task.priority}">${this.getPriorityText(task.priority)}</span>
                        </div>
                        <p class="task-description">${task.description}</p>
                        <div class="task-meta">
                            <span class="task-week">الأسبوع ${task.week}</span>
                            <span>مُكلف: ${assignedUserName}</span>
                            ${isMyTask ? `<span>من: ${createdByName}</span>` : ''}
                            <span class="task-status ${task.status}">${this.getStatusText(task.status)}</span>
                        </div>
                        ${isMyTask ? `
                            <div class="task-actions">
                                ${task.status !== 'completed' ? `<button class="btn btn-secondary" onclick="system.updateTaskStatus('${task.id}', 'in_progress')">
                                    <i class="fas fa-play"></i> قيد التنفيذ
                                </button>` : ''}
                                ${task.status !== 'completed' ? `<button class="btn btn-primary" onclick="system.markTaskCompleted('${task.id}')">
                                    <i class="fas fa-check"></i> تم الإنجاز
                                </button>` : ''}
                            </div>
                        ` : ''}
                        ${task.status === 'completed' && task.completedAt ? `
                            <div class="task-completed">
                                <i class="fas fa-check-circle"></i>
                                تم الإنجاز في: ${new Date(task.completedAt).toLocaleDateString('ar-EG')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            async fetchUsersFromAPI() {
                if (!this.token) {
                    console.warn('No token available for fetchUsersFromAPI');
                    return this.users; // Fallback to localStorage
                }

                try {
                    const response = await fetch('/api/auth/users', {
                        headers: {
                            'Authorization': `Bearer ${this.token}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const apiUsers = data.users || [];
                        
                        // Convert API users format to local format
                        const formattedUsers = apiUsers.map(u => ({
                            id: u.id,
                            fullName: u.name || u.email,
                            name: u.name,
                            email: u.email,
                            type: u.user_type || u.type || 'employee',
                            user_type: u.user_type || 'employee',
                            department: u.department || null
                        }));

                        // Update local users array
                        this.users = formattedUsers;
                        console.log('Fetched users from API:', formattedUsers.length);
                        return formattedUsers;
                    } else {
                        const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                        console.error('Failed to fetch users:', response.status, errorData);
                        return this.users; // Fallback to localStorage
                    }
                } catch (error) {
                    console.error('Error fetching users from API:', error);
                    return this.users; // Fallback to localStorage
                }
            }

            async getUserOptions() {
                // Fetch users from API first
                const users = await this.fetchUsersFromAPI();
                return users
                    .filter(u => (u.user_type || u.type) !== 'admin')
                    .map(u => {
                        const name = u.name || u.fullName || u.email;
                        const type = u.user_type || u.type || 'employee';
                        const dept = u.department || '';
                        return `<option value="${u.id}">${name}${type === 'employee' && dept ? ' (' + this.getDepartmentName(dept) + ')' : type === 'assistant' ? ' (مساعد)' : ''}</option>`;
                    })
                    .join('');
            }

            async getEmployeeOptions() {
                // Fetch users from API first
                const users = await this.fetchUsersFromAPI();
                return users
                    .filter(u => (u.user_type || u.type) === 'employee')
                    .map(u => {
                        const name = u.name || u.fullName || u.email;
                        const dept = u.department || '';
                        return `<option value="${u.id}">${name}${dept ? ' (' + this.getDepartmentName(dept) + ')' : ''}</option>`;
                    })
                    .join('');
            }

            async getUsersList() {
                // Fetch users from API first
                const users = await this.fetchUsersFromAPI();
                return users
                    .filter(u => (u.user_type || u.type) !== 'admin')
                    .map(u => {
                        const name = u.name || u.fullName || u.email;
                        const type = u.user_type || u.type || 'employee';
                        return `
                            <div class="user-item" data-user-id="${u.id}" data-user-name="${name}" style="cursor: pointer;" onclick="app.showEmployeePage(${u.id}, '${name.replace(/'/g, "\\'")}')">
                                <span>${name}</span>
                                <span>${u.email}</span>
                                <span>${type === 'employee' ? this.getDepartmentName(u.department || '') : 'مساعد'}</span>
                            </div>
                        `;
                    })
                    .join('');
            }

            getDepartmentName(department) {
                const departments = {
                    'photographer': 'Photographer',
                    'graphic-designer': 'Graphic Designer',
                    'media-buyer': 'Media Buyer',
                    'account-manager': 'Account Manager',
                    'montier': 'Montier',
                    'content': 'Content',
                    'moderator': 'Moderator'
                };
                return departments[department] || department;
            }

            getPriorityText(priority) {
                const priorities = {
                    'low': 'منخفضة',
                    'medium': 'متوسطة',
                    'high': 'عالية'
                };
                return priorities[priority] || priority;
            }

            getStatusText(status) {
                const statuses = {
                    'active': 'نشطة',
                    'completed': 'مكتملة',
                    'overdue': 'متأخرة'
                };
                return statuses[status] || status;
            }

            createModal(title, content) {
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>${title}</h3>
                            <button class="modal-close">&times;</button>
                        </div>
                        <div class="modal-body">
                            ${content}
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                modal.querySelector('.modal-close').addEventListener('click', () => {
                    this.closeModal(modal);
                });

                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        this.closeModal(modal);
                    }
                });

                return modal;
            }

            closeModal(modal) {
                document.body.removeChild(modal);
            }
            showMessage(message, type) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}`;
                messageDiv.textContent = message;

                document.body.appendChild(messageDiv);

                setTimeout(() => {
                    if (document.body.contains(messageDiv)) {
                        document.body.removeChild(messageDiv);
                    }
                }, 3000);
            }

            generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            }

            saveUsers() {
                localStorage.setItem('4am_users', JSON.stringify(this.users));
            }

            saveTasks() {
                localStorage.setItem('4am_tasks', JSON.stringify(this.tasks));
            }

            saveIncentives() {
                localStorage.setItem('4am_incentives', JSON.stringify(this.incentives));
            }
        }

        // Initialize the system when DOM is loaded
        let system;
        document.addEventListener('DOMContentLoaded', () => {
            system = new FourAMCompleteSystem();
        });
    </script>
</body>

</html>